# WitnessOS Hybrid Architecture Configuration
# Main API Router with Railway Python Engine Integration
# Python engines: Railway (Swiss Ephemeris + Consciousness Engines)
# Cloudflare: Auth, Storage, API Gateway, Workflows

name = "witnessos-api-router"
main = "src/workers/index.ts"
compatibility_date = "2024-01-15"
compatibility_flags = ["nodejs_compat"]

# Custom domain routes (managed via Cloudflare Dashboard)
# routes = [
#   { pattern = "api.witnessos.space/*", zone_id = "cf14b78dd6490cd4e21cd91af1ac7cb7" }
# ]

# Service bindings to specialized workers (RPC)
[[services]]
binding = "ENGINE_SERVICE"
service = "witnessos-engine-service"

[[services]]
binding = "FORECAST_SERVICE"
service = "witnessos-forecast-service"

[[services]]
binding = "AI_SERVICE"
service = "witnessos-ai-service"

# Durable Objects for state management
[[durable_objects.bindings]]
name = "ENGINE_COORDINATOR"
class_name = "EngineCoordinator"
script_name = "witnessos-api-router"

[[durable_objects.bindings]]
name = "FORECAST_SESSION"
class_name = "ForecastSession"
script_name = "witnessos-api-router"

# Workflow Service bindings (temporarily disabled for deployment)
# [[services]]
# binding = "CONSCIOUSNESS_WORKFLOW"
# service = "witnessos-consciousness-workflow"

# [[services]]
# binding = "INTEGRATION_WORKFLOW"
# service = "witnessos-integration-workflow"

# KV Namespaces for caching and data
[[kv_namespaces]]
binding = "KV_CACHE"
id = "d5aa9b42b2f948bfa59143d5a56ea58b"
preview_id = "d5aa9b42b2f948bfa59143d5a56ea58b"

[[kv_namespaces]]
binding = "KV_USER_PROFILES"
id = "6df29230ffca4e7c8299decdf0a2121f"
preview_id = "6df29230ffca4e7c8299decdf0a2121f"

[[kv_namespaces]]
binding = "KV_FORECASTS"
id = "2a075a9931374c22ba032d7c7cdb6054"
preview_id = "2a075a9931374c22ba032d7c7cdb6054"

[[kv_namespaces]]
binding = "KV_ENGINE_DATA"
id = "317be7d22ee14e51b1bed3d15145dd51"
preview_id = "317be7d22ee14e51b1bed3d15145dd51"

[[kv_namespaces]]
binding = "KV_SECRETS"
id = "74748736c9584954b5191d3ebe3300ac"
preview_id = "74748736c9584954b5191d3ebe3300ac"

# D1 Database for persistent data
[[d1_databases]]
binding = "DB"
database_name = "witnessos-db"
database_id = "36b03146-4184-45cc-9ed6-a24f0747cdb5"

# R2 Buckets for file storage
[[r2_buckets]]
binding = "REPORTS"
bucket_name = "witnessos-reports"

# Environment Variables
[vars]
ENVIRONMENT = "production"
API_VERSION = "2.0"
ENABLE_CACHING = "true"
ENABLE_ANALYTICS = "true"
CORS_ORIGIN = "*"
RATE_LIMIT_MAX = "1000"
RATE_LIMIT_WINDOW = "60000"
# Railway Python Engine Integration
RAILWAY_BASE_URL = "https://webshore-witnessos-aleph-production.up.railway.app"
PYTHON_ENGINES_ENABLED = "true"
SWISS_EPHEMERIS_ENABLED = "true"

# Secrets (set via wrangler secret put)
# JWT_SECRET
# OPENROUTER_API_KEY
# RAILWAY_API_KEY

# Migrations for Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = ["EngineCoordinator", "ForecastSession"]

# Build configuration
[build]
command = "npm run build"

# Development configuration
[env.development]
name = "witnessos-api-router-dev"
compatibility_date = "2024-01-15"

[env.development.vars]
ENVIRONMENT = "development"
API_VERSION = "2.0-dev"
ENABLE_CACHING = "false"
CORS_ORIGIN = "*"
RATE_LIMIT_MAX = "50"
RATE_LIMIT_WINDOW = "60000"
RAILWAY_BASE_URL = "https://webshore-witnessos-aleph-production.up.railway.app"
PYTHON_ENGINES_ENABLED = "true"
SWISS_EPHEMERIS_ENABLED = "true"

# Staging configuration
[env.staging]
name = "witnessos-api-router-staging"
routes = [
  { pattern = "api-staging.witnessos.space/*", zone_id = "cf14b78dd6490cd4e21cd91af1ac7cb7" }
]

# Staging KV Namespaces
[[env.staging.kv_namespaces]]
binding = "KV_CACHE"
id = "d5aa9b42b2f948bfa59143d5a56ea58b"
preview_id = "d5aa9b42b2f948bfa59143d5a56ea58b"

[[env.staging.kv_namespaces]]
binding = "KV_USER_PROFILES"
id = "6df29230ffca4e7c8299decdf0a2121f"
preview_id = "6df29230ffca4e7c8299decdf0a2121f"

[[env.staging.kv_namespaces]]
binding = "KV_FORECASTS"
id = "2a075a9931374c22ba032d7c7cdb6054"
preview_id = "2a075a9931374c22ba032d7c7cdb6054"

[[env.staging.kv_namespaces]]
binding = "KV_ENGINE_DATA"
id = "317be7d22ee14e51b1bed3d15145dd51"
preview_id = "317be7d22ee14e51b1bed3d15145dd51"

[[env.staging.kv_namespaces]]
binding = "KV_SECRETS"
id = "74748736c9584954b5191d3ebe3300ac"
preview_id = "74748736c9584954b5191d3ebe3300ac"

# Staging D1 Database
[[env.staging.d1_databases]]
binding = "DB"
database_name = "witnessos-db"
database_id = "36b03146-4184-45cc-9ed6-a24f0747cdb5"

# Staging R2 Buckets
[[env.staging.r2_buckets]]
binding = "REPORTS"
bucket_name = "witnessos-reports"

# Staging Durable Objects
[[env.staging.durable_objects.bindings]]
name = "ENGINE_COORDINATOR"
class_name = "EngineCoordinator"
script_name = "witnessos-api-router-staging"

[[env.staging.durable_objects.bindings]]
name = "FORECAST_SESSION"
class_name = "ForecastSession"
script_name = "witnessos-api-router-staging"

# Staging Workflows - Service bindings to dedicated workflow workers
[[env.staging.services]]
binding = "CONSCIOUSNESS_WORKFLOW"
service = "witnessos-consciousness-workflow-staging"

[[env.staging.services]]
binding = "INTEGRATION_WORKFLOW"
service = "witnessos-integration-workflow-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
API_VERSION = "2.0-staging"
ENABLE_CACHING = "false"
ENABLE_ANALYTICS = "true"
CORS_ORIGIN = "*"
RATE_LIMIT_MAX = "100"
RATE_LIMIT_WINDOW = "60000"
RAILWAY_BASE_URL = "https://webshore-witnessos-aleph-production.up.railway.app"
PYTHON_ENGINES_ENABLED = "true"
SWISS_EPHEMERIS_ENABLED = "true"

# Production configuration
[env.production]
name = "witnessos-api-router-prod"
routes = [
  { pattern = "api-v2.witnessos.space/*", zone_id = "cf14b78dd6490cd4e21cd91af1ac7cb7" }
]

# Production KV Namespaces
[[env.production.kv_namespaces]]
binding = "KV_CACHE"
id = "d5aa9b42b2f948bfa59143d5a56ea58b"
preview_id = "d5aa9b42b2f948bfa59143d5a56ea58b"

[[env.production.kv_namespaces]]
binding = "KV_USER_PROFILES"
id = "6df29230ffca4e7c8299decdf0a2121f"
preview_id = "6df29230ffca4e7c8299decdf0a2121f"

[[env.production.kv_namespaces]]
binding = "KV_FORECASTS"
id = "2a075a9931374c22ba032d7c7cdb6054"
preview_id = "2a075a9931374c22ba032d7c7cdb6054"

[[env.production.kv_namespaces]]
binding = "KV_ENGINE_DATA"
id = "317be7d22ee14e51b1bed3d15145dd51"
preview_id = "317be7d22ee14e51b1bed3d15145dd51"

[[env.production.kv_namespaces]]
binding = "KV_SECRETS"
id = "74748736c9584954b5191d3ebe3300ac"
preview_id = "74748736c9584954b5191d3ebe3300ac"

# Production D1 Database
[[env.production.d1_databases]]
binding = "DB"
database_name = "witnessos-db"
database_id = "36b03146-4184-45cc-9ed6-a24f0747cdb5"

# Production R2 Buckets
[[env.production.r2_buckets]]
binding = "REPORTS"
bucket_name = "witnessos-reports"

# Production Durable Objects
[[env.production.durable_objects.bindings]]
name = "ENGINE_COORDINATOR"
class_name = "EngineCoordinator"
script_name = "witnessos-api-router-prod"

[[env.production.durable_objects.bindings]]
name = "FORECAST_SESSION"
class_name = "ForecastSession"
script_name = "witnessos-api-router-prod"

# Production Workflows - Service bindings to dedicated workflow workers
[[env.production.services]]
binding = "CONSCIOUSNESS_WORKFLOW"
service = "witnessos-consciousness-workflow-prod"

[[env.production.services]]
binding = "INTEGRATION_WORKFLOW"
service = "witnessos-integration-workflow-prod"

[env.production.vars]
ENVIRONMENT = "production"
API_VERSION = "2.0"
ENABLE_CACHING = "true"
ENABLE_ANALYTICS = "true"
CORS_ORIGIN = "*"
RATE_LIMIT_MAX = "1000"
RATE_LIMIT_WINDOW = "60000"
RAILWAY_BASE_URL = "https://webshore-witnessos-aleph-production.up.railway.app"
PYTHON_ENGINES_ENABLED = "true"
SWISS_EPHEMERIS_ENABLED = "true"
